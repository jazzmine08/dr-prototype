{% extends "base.html" %}
{% block title %}Results — DR Ensemble{% endblock %}

{% block content %}
<h3 class="mb-2">Results</h3>
<p class="text-muted mt-0">
    Select dataset, then select a run to view learning curves, confusion matrix, and classification report.
</p>

<style>
    .gridx {
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 14px;
    }

    @media (max-width: 1000px) {
        .gridx {
            grid-template-columns: 1fr;
        }
    }

    .runs {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
    }

    .run-item {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px 12px;
        cursor: pointer;
        background: #fff;
    }

    .run-item:hover {
        background: #f9fafb;
    }

    .run-item.active {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    .run-title {
        font-weight: 800;
        font-size: 13px;
    }

    .run-sub {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }

    .img-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    @media (max-width: 1000px) {
        .img-grid {
            grid-template-columns: 1fr;
        }
    }

    img.preview {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #fff;
        display: none;
    }

    img.preview[src] {
        display: block;
    }

    pre.report {
        white-space: pre-wrap;
        background: #0b0f14;
        color: #d8e1ff;
        padding: 12px;
        border-radius: 12px;
        overflow: auto;
        font-family: Consolas, monospace;
        font-size: 13px;
    }

    .kpi {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .kpi .box {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px 12px;
        background: #fff;
    }

    .kpi .label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 700;
    }

    .kpi .val {
        font-size: 16px;
        font-weight: 900;
        margin-top: 4px;
    }
</style>

<div class="gridx">
    <!-- LEFT -->
    <div class="card shadow-sm p-3">
        <label class="fw-bold">Dataset</label>
        <select id="datasetSelect" class="form-select"></select>

        <div class="d-flex align-items-center gap-2 mt-3">
            <button class="btn btn-outline-secondary" id="btnRefresh">Refresh Runs</button>
            <span class="text-muted" id="runCount"></span>
        </div>

        <div class="runs" id="runsList"></div>
    </div>

    <!-- RIGHT -->
    <div class="card shadow-sm p-3">
        <div class="fw-bold" style="font-size:16px;">Selected Run</div>
        <div class="text-muted" id="selectedRun">None</div>
        <div class="text-muted" id="runDir" style="margin-top:4px;"></div>

        <div class="kpi" id="kpis" style="display:none;">
            <div class="box">
                <div class="label">QWK (Kappa)</div>
                <div class="val" id="kappaVal">-</div>
            </div>
            <div class="box">
                <div class="label">Best Val Acc</div>
                <div class="val" id="bestValAcc">-</div>
            </div>
            <div class="box">
                <div class="label">Best Val Loss</div>
                <div class="val" id="bestValLoss">-</div>
            </div>
            <div class="box">
                <div class="label">Eval Accuracy</div>
                <div class="val" id="evalAcc">-</div>
            </div>
        </div>

        <div class="img-grid mt-3">
            <div>
                <div class="text-muted fw-bold mb-2">Accuracy Curve</div>
                <img id="imgAcc" class="preview" alt="Accuracy curve" />
            </div>

            <div>
                <div class="text-muted fw-bold mb-2">Loss Curve</div>
                <img id="imgLoss" class="preview" alt="Loss curve" />
            </div>

            <div style="grid-column: 1 / -1;">
                <div class="text-muted fw-bold mb-2">Confusion Matrix</div>
                <img id="imgCM" class="preview" alt="Confusion matrix" />
            </div>
        </div>

        <div class="mt-3">
            <div class="text-muted fw-bold mb-2">Classification Report</div>
            <pre id="reportBox" class="report">(select a run)</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const datasetSelect = document.getElementById("datasetSelect");
    const runsList = document.getElementById("runsList");
    const runCount = document.getElementById("runCount");

    const selectedRun = document.getElementById("selectedRun");
    const runDir = document.getElementById("runDir");

    const kpis = document.getElementById("kpis");
    const kappaVal = document.getElementById("kappaVal");
    const bestValAcc = document.getElementById("bestValAcc");
    const bestValLoss = document.getElementById("bestValLoss");
    const evalAcc = document.getElementById("evalAcc");

    const imgAcc = document.getElementById("imgAcc");
    const imgLoss = document.getElementById("imgLoss");
    const imgCM = document.getElementById("imgCM");

    const reportBox = document.getElementById("reportBox");

    function clearDetails() {
        selectedRun.textContent = "None";
        runDir.textContent = "";
        kpis.style.display = "none";
        kappaVal.textContent = "-";
        bestValAcc.textContent = "-";
        bestValLoss.textContent = "-";
        evalAcc.textContent = "-";
        imgAcc.removeAttribute("src");
        imgLoss.removeAttribute("src");
        imgCM.removeAttribute("src");
        reportBox.textContent = "(select a run)";
    }

    function fmt(x) {
        if (x === null || x === undefined || x === "") return "-";
        const n = Number(x);
        return isNaN(n) ? String(x) : n.toFixed(4);
    }

    // Try multiple endpoints for datasets (some apps expose /datasets, some /api/datasets)
    async function loadDatasets() {
        const endpoints = ["/api/datasets", "/datasets"];
        let data = null;

        for (const url of endpoints) {
            try {
                const res = await fetch(url);
                if (!res.ok) continue;
                data = await res.json();
                if (data) break;
            } catch (e) { }
        }

        datasetSelect.innerHTML = "";
        const dsList = (data && data.datasets) ? data.datasets : [];

        if (!dsList.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "(no datasets)";
            datasetSelect.appendChild(opt);
            return;
        }

        dsList.forEach(ds => {
            const opt = document.createElement("option");
            opt.value = ds;
            opt.textContent = (ds === "aptos2019") ? "APTOS 2019" : (ds === "drtid") ? "DRTiD" : ds;
            datasetSelect.appendChild(opt);
        });

        if ([...datasetSelect.options].some(o => o.value === "aptos2019")) {
            datasetSelect.value = "aptos2019";
        }
    }

    // Handle different list shapes from backend
    function extractRunIds(data) {
        if (!data) return [];

        // {status:"ok", runs:[...]}
        if (Array.isArray(data.runs)) return data.runs;

        // {status:"ok", items:[{run_id:...}, ...]}
        if (Array.isArray(data.items)) return data.items.map(x => x.run_id).filter(Boolean);

        return [];
    }

    async function refreshRuns() {
        const ds = datasetSelect.value || "aptos2019";
        runsList.innerHTML = "<div class='text-muted'>Loading runs...</div>";
        runCount.textContent = "";

        try {
            const res = await fetch(`/api/results/list?dataset=${encodeURIComponent(ds)}`);
            const data = await res.json();

            if (data.status && data.status !== "ok") {
                runsList.innerHTML = `<div class='text-muted'>❌ ${data.message || "Failed to load runs"}</div>`;
                clearDetails();
                return;
            }

            const runIds = extractRunIds(data);
            runCount.textContent = `${runIds.length} run(s)`;

            if (runIds.length === 0) {
                runsList.innerHTML = "<div class='text-muted'>No runs yet. Train a model first.</div>";
                clearDetails();
                return;
            }

            runsList.innerHTML = "";
            runIds.forEach(runId => {
                const item = document.createElement("div");
                item.className = "run-item";
                item.innerHTML = `
                    <div class="run-title">${runId}</div>
                    <div class="run-sub">Click to view details</div>
                `;
                item.addEventListener("click", async () => {
                    [...document.querySelectorAll(".run-item")].forEach(x => x.classList.remove("active"));
                    item.classList.add("active");
                    await loadRunDetails(ds, runId);
                });
                runsList.appendChild(item);
            });

            const first = runsList.querySelector(".run-item");
            if (first) first.click();
        } catch (e) {
            runsList.innerHTML = "<div class='text-muted'>❌ Failed to load runs (network/API error)</div>";
            clearDetails();
        }
    }

    // ✅ Robust: metrics may be flat OR nested under summary
    function pickMetrics(obj) {
        if (!obj) return {};
        if (obj.kappa_qwk !== undefined || obj.best_val_accuracy !== undefined || obj.best_val_loss !== undefined) {
            return obj; // flat
        }
        if (obj.summary && (obj.summary.kappa_qwk !== undefined || obj.summary.best_val_accuracy !== undefined || obj.summary.best_val_loss !== undefined)) {
            return obj.summary; // nested
        }
        return obj;
    }

    // ✅ Image fallback: if backend doesn't provide images map, try standard route
    function fallbackImageUrl(ds, runId, name) {
        // adjust this if your backend uses a different image endpoint
        return `/api/results/image?dataset=${encodeURIComponent(ds)}&run_id=${encodeURIComponent(runId)}&name=${encodeURIComponent(name)}`;
    }

    async function loadRunDetails(ds, runId) {
        clearDetails();
        selectedRun.textContent = `${ds} / ${runId}`;

        try {
            const res = await fetch(`/api/results/get?dataset=${encodeURIComponent(ds)}&run_id=${encodeURIComponent(runId)}`);
            const data = await res.json();

            if (data.status !== "ok") {
                reportBox.textContent = `❌ ${data.message || "Failed to load run"}`;
                return;
            }

            runDir.textContent = data.run_dir || "";

            const metricsRaw = data.metrics || {};
            const metrics = pickMetrics(metricsRaw);

            // evaluation might be separate or inside metrics
            const evaluation = data.evaluation || {};
            const evalAccVal = (evaluation.accuracy !== undefined) ? evaluation.accuracy
                : (metrics.accuracy !== undefined) ? metrics.accuracy
                    : (metrics.eval_accuracy !== undefined) ? metrics.eval_accuracy
                        : null;

            const imgs = data.images || {};

            kpis.style.display = "flex";
            kappaVal.textContent = fmt(metrics.kappa_qwk);
            bestValAcc.textContent = fmt(metrics.best_val_accuracy);
            bestValLoss.textContent = fmt(metrics.best_val_loss);
            evalAcc.textContent = fmt(evalAccVal);

            // Prefer backend-provided URLs
            imgAcc.src = imgs["curves_accuracy.png"] || fallbackImageUrl(ds, runId, "curves_accuracy.png");
            imgLoss.src = imgs["curves_loss.png"] || fallbackImageUrl(ds, runId, "curves_loss.png");
            imgCM.src = imgs["confusion_matrix.png"] || fallbackImageUrl(ds, runId, "confusion_matrix.png");

            reportBox.textContent = data.report || "(no report.txt)";
        } catch (e) {
            reportBox.textContent = "❌ Failed to load run details (network/API error)";
        }
    }

    document.getElementById("btnRefresh").addEventListener("click", refreshRuns);
    datasetSelect.addEventListener("change", refreshRuns);

    (async function init() {
        await loadDatasets();
        await refreshRuns();
    })();
</script>
{% endblock %}