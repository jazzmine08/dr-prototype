{% extends "base.html" %}
{% block title %}Training â€” DR Ensemble{% endblock %}

{% block content %}
<h3 class="mb-2">Training</h3>
<p class="text-muted mt-0">
  Choose dataset (APTOS 2019 or DRTiD), set parameters, and start training.
</p>

<style>
  /* page-specific styles only (safe with base.html) */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media (max-width: 900px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }

  .log {
    height: 360px;
    overflow: auto;
    background: #0b0f14;
    color: #d8e1ff;
    padding: 12px;
    border-radius: 12px;
    font-family: Consolas, monospace;
    font-size: 13px;
  }

  label {
    font-weight: 700;
    font-size: 13px;
  }

  .status {
    font-weight: 800;
  }

  select,
  input {
    width: 100%;
    box-sizing: border-box;
  }
</style>

<div class="card shadow-sm p-3">
  <div class="grid">
    <div>
      <label>Dataset</label>
      <select id="datasetSelect" class="form-select"></select>
    </div>

    <div>
      <label>Train Mode</label>
      <select id="trainMode" class="form-select">
        <option value="all">Train ALL 3 CNN</option>
        <option value="single">Train SINGLE model</option>
      </select>

      <div id="singleModelWrap" style="margin-top:12px; display:none;">
        <label>Model Name (single)</label>
        <select id="modelName" class="form-select">
          <option value="efficientnet">EfficientNet</option>
          <option value="densenet">DenseNet</option>
          <option value="inceptionresnet">InceptionResNet</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid mt-3">
    <div>
      <label>Epochs</label>
      <input id="epochs" type="number" min="1" value="20" class="form-control" />
    </div>
    <div>
      <label>Batch Size</label>
      <input id="batchSize" type="number" min="1" value="16" class="form-control" />
    </div>
    <div>
      <label>Image Size</label>
      <input id="imgSize" type="number" min="32" value="224" class="form-control" />
    </div>
    <div>
      <label>Warmup Epochs</label>
      <input id="warmupEpochs" type="number" min="0" value="2" class="form-control" />
    </div>
    <div>
      <label>LR</label>
      <input id="lr" type="number" step="0.000001" value="0.0001" class="form-control" />
    </div>
    <div>
      <label>Fine-tune LR</label>
      <input id="fineTuneLr" type="number" step="0.000001" value="0.00001" class="form-control" />
    </div>
    <div>
      <label>Dropout</label>
      <input id="dropout" type="number" step="0.01" min="0" max="0.9" value="0.3" class="form-control" />
    </div>
    <div></div>
  </div>

  <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
    <button class="btn btn-success" id="btnStart">Start Training</button>
    <button class="btn btn-outline-secondary" id="btnClear">Clear Log</button>
    <div class="status" id="statusText">Status: idle</div>
  </div>

</div>

<div class="card shadow-sm p-3 mt-3">
  <h5 class="fw-bold mb-2">Training Logs</h5>
  <div id="logBox" class="log"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
  // --- DOM ---
  const logBox = document.getElementById("logBox");
  const statusText = document.getElementById("statusText");
  const datasetSelect = document.getElementById("datasetSelect");
  const trainMode = document.getElementById("trainMode");
  const singleModelWrap = document.getElementById("singleModelWrap");
  const modelName = document.getElementById("modelName");
  const btnStart = document.getElementById("btnStart");
  const btnClear = document.getElementById("btnClear");

  // --- helpers ---
  function addLog(msg) {
    const ts = new Date().toLocaleTimeString();
    logBox.innerHTML += `[${ts}] ${msg}<br/>`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  function setStatus(s) {
    statusText.textContent = "Status: " + s;
  }

  function niceDatasetLabel(ds) {
    if (ds === "aptos2019") return "APTOS 2019";
    if (ds === "drtid") return "DRTiD";
    return ds;
  }

  // Safe JSON fetch helper: avoids "Unexpected token '<'"
  async function fetchJson(url, opts) {
    const res = await fetch(url, opts);
    const text = await res.text();

    let data = null;
    try {
      data = text ? JSON.parse(text) : null;
    } catch (e) {
      throw new Error(`Non-JSON response from ${url} (HTTP ${res.status}): ${text.slice(0, 160)}`);
    }

    if (!res.ok) {
      const msg = (data && (data.message || data.error)) ? (data.message || data.error) : `HTTP ${res.status}`;
      throw new Error(`${(opts && opts.method) ? opts.method : "GET"} ${url} failed (${res.status}) - ${msg}`);
    }
    return data;
  }

  // --- Socket.IO optional ---
  const socket = (window.io) ? io(window.location.origin) : null;
  if (!socket) {
    addLog("âš ï¸ Socket.IO not loaded. Page will still work, but realtime logs may not appear.");
  }

  // --- load datasets (UPDATED: /api/datasets) ---
  async function loadDatasets() {
    datasetSelect.innerHTML = "";

    try {
      const data = await fetchJson("/api/datasets");
      const datasets = (data && data.datasets) ? data.datasets : [];

      if (!datasets.length) throw new Error("No datasets returned.");

      datasets.forEach(ds => {
        const opt = document.createElement("option");
        opt.value = ds;
        opt.textContent = niceDatasetLabel(ds);
        datasetSelect.appendChild(opt);
      });

      if ([...datasetSelect.options].some(o => o.value === "aptos2019")) {
        datasetSelect.value = "aptos2019";
      } else if (datasetSelect.options.length > 0) {
        datasetSelect.value = datasetSelect.options[0].value;
      }

      addLog(`âœ… Loaded datasets: ${datasets.join(", ")}`);
      setStatus("idle");
    } catch (err) {
      // fallback so page is usable even if API fails
      ["aptos2019", "drtid"].forEach(ds => {
        const opt = document.createElement("option");
        opt.value = ds;
        opt.textContent = niceDatasetLabel(ds);
        datasetSelect.appendChild(opt);
      });
      datasetSelect.value = "aptos2019";

      addLog(`âš ï¸ /api/datasets failed, using fallback options: aptos2019, drtid (${err.message})`);
      setStatus("warning");
    }
  }

  // --- mode toggle ---
  trainMode.addEventListener("change", () => {
    singleModelWrap.style.display = (trainMode.value === "single") ? "block" : "none";
  });

  // --- clear log ---
  btnClear.addEventListener("click", () => {
    logBox.innerHTML = "";
    setStatus("idle");
    addLog("ðŸ§¹ Log cleared.");
  });

  // --- start training (UPDATED: /api/start_training) ---
  btnStart.addEventListener("click", async () => {
    try {
      const ds = datasetSelect.value || "aptos2019";

      const payload = {
        dataset: ds,
        epochs: Number(document.getElementById("epochs").value || 20),
        batch_size: Number(document.getElementById("batchSize").value || 16),
        img_size: Number(document.getElementById("imgSize").value || 224),
        warmup_epochs: Number(document.getElementById("warmupEpochs").value || 2),
        lr: Number(document.getElementById("lr").value || 1e-4),
        fine_tune_lr: Number(document.getElementById("fineTuneLr").value || 1e-5),
        dropout: Number(document.getElementById("dropout").value || 0.3),
      };

      if (trainMode.value === "single") {
        payload.model = modelName.value; // your backend may ignore it; safe to send
      }

      setStatus(`starting training (${ds})...`);
      addLog(`â–¶ï¸ Training request: dataset=${ds}, mode=${trainMode.value}${trainMode.value === "single" ? ", model=" + modelName.value : ""}`);
      btnStart.disabled = true;

      const out = await fetchJson("/api/start_training", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (out.status === "ok") {
        setStatus(`running (${ds})`);
        addLog(`âœ… ${out.message || "Training started."}`);
      } else {
        setStatus("error");
        addLog(`âŒ ${out.message || "Unknown error"}`);
        btnStart.disabled = false;
      }
    } catch (err) {
      setStatus("error");
      addLog("âŒ " + err.message);
      btnStart.disabled = false;
    }
  });

  // --- Socket listeners (optional) ---
  if (socket) {
    socket.on("connect", () => addLog("ðŸ”Œ Socket connected."));
    socket.on("disconnect", () => addLog("âš ï¸ Socket disconnected."));

    // These event names should match what your trainer emits
    const logEvents = ["train_log", "training_log"];
    const errEvents = ["train_error", "training_error"];
    const doneEvents = ["train_done", "training_done"];

    logEvents.forEach(ev => socket.on(ev, (data) => {
      const msg = (data && (data.message || data.msg)) ? (data.message || data.msg) : "";
      if (msg) addLog(msg);
    }));

    errEvents.forEach(ev => socket.on(ev, (data) => {
      const msg = (data && (data.message || data.msg)) ? (data.message || data.msg) : "error";
      addLog("âŒ " + msg);
      setStatus("error");
      btnStart.disabled = false;
    }));

    doneEvents.forEach(ev => socket.on(ev, (data) => {
      const msg = (data && (data.message || data.msg)) ? (data.message || data.msg) : "done";
      addLog("âœ… " + msg);
      setStatus("done");
      btnStart.disabled = false;
    }));
  }

  // init
  loadDatasets();
</script>
{% endblock %}