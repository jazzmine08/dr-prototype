{% extends "base.html" %}
{% block title %}Training â€” DR Ensemble{% endblock %}

{% block content %}
<h3 class="mb-2">Training</h3>
<p class="text-muted mt-0">
  Choose dataset (APTOS 2019 or DRTiD), set parameters, and start training.
</p>

<style>
  /* page-specific styles only (safe with base.html) */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media (max-width: 900px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }

  .log {
    height: 360px;
    overflow: auto;
    background: #0b0f14;
    color: #d8e1ff;
    padding: 12px;
    border-radius: 12px;
    font-family: Consolas, monospace;
    font-size: 13px;
  }

  label {
    font-weight: 700;
    font-size: 13px;
  }

  .status {
    font-weight: 800;
  }

  /* Make inputs look consistent even if base uses Bootstrap */
  select,
  input {
    width: 100%;
    box-sizing: border-box;
  }
</style>

<div class="card shadow-sm p-3">
  <div class="grid">
    <div>
      <label>Dataset</label>
      <select id="datasetSelect" class="form-select"></select>
    </div>

    <div>
      <label>Train Mode</label>
      <select id="trainMode" class="form-select">
        <option value="all">Train ALL 3 CNN</option>
        <option value="single">Train SINGLE model</option>
      </select>

      <div id="singleModelWrap" style="margin-top:12px; display:none;">
        <label>Model Name (single)</label>
        <select id="modelName" class="form-select">
          <option value="efficientnet">EfficientNet</option>
          <option value="densenet">DenseNet</option>
          <option value="inceptionresnet">InceptionResNet</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid mt-3">
    <div>
      <label>Epochs</label>
      <input id="epochs" type="number" min="1" value="20" class="form-control" />
    </div>
    <div>
      <label>Batch Size</label>
      <input id="batchSize" type="number" min="1" value="16" class="form-control" />
    </div>
    <div>
      <label>Image Size</label>
      <input id="imgSize" type="number" min="32" value="224" class="form-control" />
    </div>
    <div>
      <label>Warmup Epochs</label>
      <input id="warmupEpochs" type="number" min="0" value="2" class="form-control" />
    </div>
    <div>
      <label>LR</label>
      <input id="lr" type="number" step="0.000001" value="0.0001" class="form-control" />
    </div>
    <div>
      <label>Fine-tune LR</label>
      <input id="fineTuneLr" type="number" step="0.000001" value="0.00001" class="form-control" />
    </div>
    <div>
      <label>Dropout</label>
      <input id="dropout" type="number" step="0.01" min="0" max="0.9" value="0.3" class="form-control" />
    </div>
    <div></div>
  </div>

  <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
    <button class="btn btn-success" id="btnStart">Start Training</button>
    <button class="btn btn-outline-secondary" id="btnClear">Clear Log</button>
    <div class="status" id="statusText">Status: idle</div>
  </div>
</div>

<div class="card shadow-sm p-3 mt-3">
  <h5 class="fw-bold mb-2">Training Logs</h5>
  <div id="logBox" class="log"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO (optional). Kalau CDN gagal, halaman tetap jalan. -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
  // --- helpers ---
  const logBox = document.getElementById("logBox");
  const statusText = document.getElementById("statusText");

  function addLog(msg) {
    const ts = new Date().toLocaleTimeString();
    logBox.innerHTML += `[${ts}] ${msg}<br/>`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  function setStatus(s) {
    statusText.textContent = "Status: " + s;
  }

  // --- Socket.IO optional (biar JS gak crash kalau CDN gagal) ---
  const socket = (window.io) ? io() : null;
  if (!socket) {
    addLog("âš ï¸ Socket.IO not loaded. Page will still work, but realtime logs may not appear.");
  }

  // --- DOM elements ---
  const datasetSelect = document.getElementById("datasetSelect");
  const trainMode = document.getElementById("trainMode");
  const singleModelWrap = document.getElementById("singleModelWrap");
  const modelName = document.getElementById("modelName");
  const btnStart = document.getElementById("btnStart");
  const btnClear = document.getElementById("btnClear");

  // --- load datasets ---
  async function loadDatasets() {
    try {
      const res = await fetch("/datasets");
      if (!res.ok) throw new Error(`GET /datasets failed (${res.status})`);
      const data = await res.json();

      datasetSelect.innerHTML = "";
      (data.datasets || []).forEach(ds => {
        const opt = document.createElement("option");
        opt.value = ds;
        opt.textContent = (ds === "aptos2019") ? "APTOS 2019"
          : (ds === "drtid") ? "DRTiD"
            : ds;
        datasetSelect.appendChild(opt);
      });

      if ([...datasetSelect.options].some(o => o.value === "aptos2019")) {
        datasetSelect.value = "aptos2019";
      } else if (datasetSelect.options.length > 0) {
        datasetSelect.value = datasetSelect.options[0].value;
      }

      addLog(`âœ… Loaded datasets: ${(data.datasets || []).join(", ") || "(none)"}`);
    } catch (err) {
      addLog("âŒ Failed to load datasets: " + err.message);
      setStatus("error");
    }
  }

  // --- mode toggle ---
  trainMode.addEventListener("change", () => {
    singleModelWrap.style.display = (trainMode.value === "single") ? "block" : "none";
  });

  // --- clear log ---
  btnClear.addEventListener("click", () => {
    logBox.innerHTML = "";
    setStatus("idle");
    addLog("ðŸ§¹ Log cleared.");
  });

  // --- start training ---
  btnStart.addEventListener("click", async () => {
    try {
      const ds = datasetSelect.value || "aptos2019";

      const payload = {
        dataset: ds,
        epochs: Number(document.getElementById("epochs").value || 20),
        batch_size: Number(document.getElementById("batchSize").value || 16),
        img_size: Number(document.getElementById("imgSize").value || 224),
        warmup_epochs: Number(document.getElementById("warmupEpochs").value || 2),
        lr: Number(document.getElementById("lr").value || 1e-4),
        fine_tune_lr: Number(document.getElementById("fineTuneLr").value || 1e-5),
        dropout: Number(document.getElementById("dropout").value || 0.3),
      };

      // OPTIONAL: kalau kamu nanti tambahin <input id="limit"> baru akan kepake
      const limitEl = document.getElementById("limit");
      if (limitEl && Number(limitEl.value) > 0) payload.limit = Number(limitEl.value);

      if (trainMode.value === "single") {
        payload.model = modelName.value;
      }

      setStatus(`starting training (${ds})...`);
      addLog(`â–¶ï¸ Training request: dataset=${ds}, mode=${trainMode.value}${trainMode.value === "single" ? ", model=" + modelName.value : ""}`);

      const resp = await fetch("/start_training", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        const txt = await resp.text().catch(() => "");
        throw new Error(`POST /start_training failed (${resp.status}). ${txt}`);
      }

      const out = await resp.json();

      if (out.status === "ok") {
        setStatus(`running (${ds})`);
        addLog(`âœ… ${out.message || "Training started."}`);
        if (out.processed_dir) addLog(`ðŸ“ processed_dir used: ${out.processed_dir}`);
      } else {
        setStatus("error");
        addLog(`âŒ ${out.message || "Unknown error"}`);
      }
    } catch (err) {
      setStatus("error");
      addLog("âŒ " + err.message);
    }
  });

  // --- Socket listeners (optional) ---
  if (socket) {
    const logEvents = ["train_log", "training_log", "log", "message"];
    const errEvents = ["train_error", "training_error", "error"];
    const doneEvents = ["train_done", "training_done", "done"];

    logEvents.forEach(ev => socket.on(ev, (data) => {
      const msg = (data && (data.message || data.msg)) ? (data.message || data.msg) : JSON.stringify(data);
      addLog(msg);
    }));

    errEvents.forEach(ev => socket.on(ev, (data) => {
      const msg = (data && (data.message || data.msg)) ? (data.message || data.msg) : JSON.stringify(data);
      addLog("âŒ " + msg);
      setStatus("error");
    }));

    doneEvents.forEach(ev => socket.on(ev, (data) => {
      const msg = (data && (data.message || data.msg)) ? (data.message || data.msg) : JSON.stringify(data);
      addLog("âœ… " + msg);
      setStatus("done");
    }));
  }

  // init
  loadDatasets();
</script>
{% endblock %}