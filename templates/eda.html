{% extends "base.html" %}
{% block title %}EDA{% endblock %}

{% block content %}
<h3>Exploratory Data Analysis (EDA)</h3>

<button id="startEdaBtn" class="btn btn-primary mt-2">
  ▶ Start EDA (APTOS + DRTiD)
</button>

<div class="progress mt-3">
  <div id="edaProgress" class="progress-bar" style="width:0%">0%</div>
</div>

<pre id="edaLog" class="bg-dark text-light p-3 mt-3" style="height:200px; overflow:auto;"></pre>

<div class="row mt-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold mb-3">APTOS</h5>
        <div id="aptosBlock">Click “Start EDA”.</div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold mb-3">DRTiD</h5>
        <div id="drtidBlock">Click “Start EDA”.</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const logEl = document.getElementById("edaLog");
  const bar = document.getElementById("edaProgress");

  function appendLog(msg) {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setProgress(p) {
    const pct = Math.max(0, Math.min(100, Number(p) || 0));
    bar.style.width = pct + "%";
    bar.textContent = pct + "%";
  }

  function renderDataset(res, title) {
    if (!res || res.status !== "ok") {
      return `<div class="text-danger">❌ ${title}: ${res ? (res.message || "EDA failed") : "No data"}</div>`;
    }

    let html = "";

    // Chart (backend returns chart_b64)
    if (res.chart_b64) {
      html += `
        <div class="mb-3">
          <img src="data:image/png;base64,${res.chart_b64}" class="img-fluid" />
        </div>
      `;
    } else {
      html += `<div class="text-muted mb-3">No chart available.</div>`;
    }

    html += `
      <ul class="mb-3">
        <li><b>Rows (train.csv):</b> ${res.num_rows ?? "None"}</li>
      </ul>
    `;

    // Label counts
    if (res.label_counts) {
      const items = Object.entries(res.label_counts)
        .sort((a, b) => Number(a[0]) - Number(b[0]))
        .map(([k, v]) => `<li>Class ${k}: ${v}</li>`)
        .join("");
      html += `
        <div class="mb-2"><b>Label counts:</b></div>
        <ul class="mb-3">${items}</ul>
      `;
    }

    // Samples (image_b64)
    if (Array.isArray(res.samples) && res.samples.length > 0) {
      const thumbs = res.samples.map(s => `
        <div style="display:inline-block; margin:6px; text-align:center;">
          <img
            src="data:image/png;base64,${s.image_b64}"
            style="width:120px; height:120px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb;"
          />
          <div class="text-muted" style="font-size:12px;">Class ${s.label}</div>
        </div>
      `).join("");
      html += `<div><b>Random samples:</b></div><div>${thumbs}</div>`;
    } else {
      html += `<div class="text-muted">No sample images returned.</div>`;
    }

    return html;
  }

  async function fetchEda(dataset) {
    const resp = await fetch("/api/eda/summary", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ dataset })
    });
    return await resp.json();
  }

  document.getElementById("startEdaBtn").onclick = async () => {
    setProgress(0);
    logEl.textContent = "";
    appendLog("▶ Starting EDA for APTOS + DRTiD...");

    try {
      setProgress(10);
      const aptos = await fetchEda("aptos2019");
      appendLog("✅ APTOS EDA fetched.");
      document.getElementById("aptosBlock").innerHTML = renderDataset(aptos, "APTOS");

      setProgress(60);
      const drtid = await fetchEda("drtid");
      appendLog("✅ DRTiD EDA fetched.");
      document.getElementById("drtidBlock").innerHTML = renderDataset(drtid, "DRTiD");

      setProgress(100);
      appendLog("✅ EDA results rendered.");
    } catch (e) {
      appendLog("❌ EDA failed: " + e);
      setProgress(0);
    }
  };
</script>
{% endblock %}