{% extends "base.html" %}
{% block title %}Preprocessing ‚Äî DR Ensemble{% endblock %}

{% block content %}
<h3 class="mb-2">Preprocessing</h3>
<p class="text-muted mt-0">
  Select dataset (APTOS 2019 or DRTiD) and run preprocessing to generate standardized images for training.
</p>

<style>
  /* keep your page-specific styles here (safe with base.html) */
  .log {
    height: 340px;
    overflow: auto;
    background: #0b0f14;
    color: #d8e1ff;
    padding: 12px;
    border-radius: 12px;
    font-family: Consolas, monospace;
    font-size: 13px;
  }

  .pill {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    background: #eef2ff;
    color: #3730a3;
    font-weight: 700;
    font-size: 12px;
  }

  .progress-wrap {
    background: #e5e7eb;
    border-radius: 999px;
    height: 18px;
    overflow: hidden;
  }

  .progress-bar-custom {
    height: 18px;
    width: 0%;
    background: #22c55e;
    transition: width 150ms linear;
  }

  .samples-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
  }

  @media (max-width: 920px) {
    .samples-grid {
      grid-template-columns: 1fr;
    }
  }

  .sample-box {
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 12px;
    background: #fff;
  }

  .sample-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .sample-img {
    width: 220px;
    height: 220px;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    background: #fff;
  }

  .tiny {
    font-size: 12px;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-2">
  <div></div>
  <span class="pill">Dataset Preprocessing</span>
</div>

<div class="card shadow-sm p-3 mb-3">
  <div class="row g-2 align-items-center">
    <div class="col-auto">
      <label for="datasetSelect" class="fw-bold">Dataset:</label>
    </div>
    <div class="col-auto">
      <select id="datasetSelect" class="form-select"></select>
    </div>

    <div class="col-auto">
      <label for="limitInput" class="text-muted">Limit (optional):</label>
    </div>
    <div class="col-auto">
      <input id="limitInput" type="number" min="1" class="form-control" placeholder="e.g., 200 (debug)"
        style="width: 180px;" />
    </div>

    <div class="col-auto">
      <button class="btn btn-primary" id="btnStart">Start Preprocessing</button>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-secondary" id="btnClear">Clear Log</button>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-secondary" id="btnShowSamples" title="Load sample (original vs processed)">Show
        Samples</button>
    </div>
  </div>

  <div class="text-muted mt-3" style="font-size: 13px;">
    Source: <b id="sourceName">-</b> &nbsp;&nbsp;|&nbsp;&nbsp;
    Output: <b id="outputPath">-</b>
  </div>

  <div class="fw-bold mt-2" id="statusText">Status: idle</div>
</div>

<div class="card shadow-sm p-3 mb-3">
  <h5 class="fw-bold mb-2">Progress</h5>
  <div class="progress-wrap">
    <div id="progressBar" class="progress-bar-custom"></div>
  </div>
  <div class="text-muted mt-2" id="progressText">0% (0 / 0)</div>
</div>

<div class="card shadow-sm p-3 mb-3">
  <h5 class="fw-bold mb-2">Sample Verification</h5>
  <p class="text-muted mt-0">
    Click <b>Show Samples</b> to load 1 sample per severity level (No DR, Moderate, Proliferative DR).
  </p>

  <div class="samples-grid">
    <div class="sample-box">
      <div class="d-flex justify-content-between">
        <b>No DR</b>
        <span class="text-muted tiny" id="samples0Meta"></span>
      </div>
      <div id="samples0" class="sample-row"><span class="text-muted">Click ‚ÄúShow Samples‚Äù.</span></div>
    </div>

    <div class="sample-box">
      <div class="d-flex justify-content-between">
        <b>Moderate</b>
        <span class="text-muted tiny" id="samples2Meta"></span>
      </div>
      <div id="samples2" class="sample-row"><span class="text-muted">Click ‚ÄúShow Samples‚Äù.</span></div>
    </div>

    <div class="sample-box">
      <div class="d-flex justify-content-between">
        <b>Proliferative DR</b>
        <span class="text-muted tiny" id="samples4Meta"></span>
      </div>
      <div id="samples4" class="sample-row"><span class="text-muted">Click ‚ÄúShow Samples‚Äù.</span></div>
    </div>
  </div>
</div>

<div class="card shadow-sm p-3">
  <h5 class="fw-bold mb-2">Logs</h5>
  <div id="logBox" class="log"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
  const logBox = document.getElementById("logBox");
  const datasetSelect = document.getElementById("datasetSelect");
  const statusText = document.getElementById("statusText");
  const sourceName = document.getElementById("sourceName");
  const outputPath = document.getElementById("outputPath");
  const limitInput = document.getElementById("limitInput");

  const btnStart = document.getElementById("btnStart");
  const btnClear = document.getElementById("btnClear");
  const btnShowSamples = document.getElementById("btnShowSamples");

  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");

  const socket = io();

  function addLog(msg) {
    const ts = new Date().toLocaleTimeString();
    logBox.innerHTML += `[${ts}] ${msg}<br/>`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  function niceDatasetName(ds) {
    if (ds === "aptos2019") return "Google Drive for Desktop (APTOS 2019)";
    if (ds === "drtid") return "Google Drive for Desktop (DRTiD)";
    return ds;
  }

  function updateSourceLine() {
    const ds = datasetSelect.value || "aptos2019";
    sourceName.textContent = niceDatasetName(ds);
    outputPath.textContent = `G:\\My Drive\\dr_prototype\\processed\\${ds}\\processed_final\\`;
  }

  function setProgress(pct, processed, total, phase) {
    const safePct = Math.max(0, Math.min(100, Number(pct) || 0));
    progressBar.style.width = safePct + "%";
    progressText.textContent = `${safePct}% (${processed || 0} / ${total || 0})${phase ? " - " + phase : ""}`;
  }

  function resetProgress() { setProgress(0, 0, 0, ""); }

  function renderSamplePair(containerId, metaId, sample, ds) {
    const el = document.getElementById(containerId);
    const meta = document.getElementById(metaId);

    el.innerHTML = "";
    meta.textContent = "";

    if (!sample || (!sample.original && !sample.processed)) {
      el.innerHTML = `<span class="text-muted">No images yet.</span>`;
      meta.textContent = `${ds}`;
      return;
    }

    const wrap = document.createElement("div");
    wrap.style.display = "flex";
    wrap.style.gap = "10px";
    wrap.style.flexWrap = "wrap";

    const makeBlock = (title, src) => {
      const block = document.createElement("div");
      block.style.display = "flex";
      block.style.flexDirection = "column";
      block.style.gap = "6px";

      const cap = document.createElement("span");
      cap.className = "text-muted tiny";
      cap.textContent = title;

      const img = document.createElement("img");
      img.src = src || "";
      img.className = "sample-img";

      block.appendChild(cap);
      block.appendChild(img);
      return block;
    };

    if (sample.original) wrap.appendChild(makeBlock("Original", sample.original));
    if (sample.processed) wrap.appendChild(makeBlock("Processed", sample.processed));

    el.appendChild(wrap);
    meta.textContent = `${ds}${sample.image_id ? " | " + sample.image_id : ""}`;
  }

  async function loadSamples(ds) {
    const url = `/preprocess_samples?dataset=${encodeURIComponent(ds)}`;
    const res = await fetch(url);
    const data = await res.json();

    const samples = (data && data.samples) ? data.samples : [];
    const s0 = samples.find(s => Number(s.class) === 0);
    const s2 = samples.find(s => Number(s.class) === 2);
    const s4 = samples.find(s => Number(s.class) === 4);

    renderSamplePair("samples0", "samples0Meta", s0, ds);
    renderSamplePair("samples2", "samples2Meta", s2, ds);
    renderSamplePair("samples4", "samples4Meta", s4, ds);
  }

  async function loadDatasets() {
    const res = await fetch("/datasets");
    const data = await res.json();
    datasetSelect.innerHTML = "";

    (data.datasets || []).forEach(ds => {
      const opt = document.createElement("option");
      opt.value = ds;
      opt.textContent = (ds === "aptos2019") ? "APTOS 2019" : (ds === "drtid") ? "DRTiD" : ds;
      datasetSelect.appendChild(opt);
    });

    if ([...datasetSelect.options].some(o => o.value === "aptos2019")) datasetSelect.value = "aptos2019";
    updateSourceLine();
  }

  datasetSelect.addEventListener("change", updateSourceLine);

  btnClear.addEventListener("click", () => {
    logBox.innerHTML = "";
    statusText.textContent = "Status: idle";
    resetProgress();
  });

  btnShowSamples.addEventListener("click", async () => {
    const ds = datasetSelect.value || "aptos2019";
    btnShowSamples.disabled = true;
    addLog(`üñºÔ∏è Loading samples for ${ds}...`);
    try {
      await loadSamples(ds);
      addLog(`‚úÖ Samples loaded.`);
    } catch (e) {
      addLog("‚ùå Failed to load samples: " + e);
    } finally {
      btnShowSamples.disabled = false;
    }
  });

  btnStart.addEventListener("click", async () => {
    const ds = datasetSelect.value || "aptos2019";
    const limitVal = limitInput.value && Number(limitInput.value) > 0 ? Number(limitInput.value) : null;

    resetProgress();
    statusText.textContent = `Status: starting preprocessing (${ds})...`;
    addLog(`‚ñ∂Ô∏è Requesting preprocessing for dataset=${ds}${limitVal ? " limit=" + limitVal : ""}`);
    btnStart.disabled = true;

    const payload = { dataset: ds };
    if (limitVal) payload.limit = limitVal;

    try {
      const resp = await fetch("/start_preprocessing", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const out = await resp.json();
      if (out.status === "ok") {
        statusText.textContent = `Status: running (${ds})`;
        addLog(`‚úÖ ${out.message}`);
      } else {
        statusText.textContent = `Status: error`;
        addLog(`‚ùå ${out.message || "Unknown error"}`);
        btnStart.disabled = false;
      }
    } catch (e) {
      statusText.textContent = `Status: error`;
      addLog(`‚ùå Failed to start preprocessing: ${e}`);
      btnStart.disabled = false;
    }
  });

  socket.on("connect", () => addLog("üîå Socket connected."));
  socket.on("disconnect", () => addLog("‚ö†Ô∏è Socket disconnected."));
  socket.on("preprocess_log", (data) => addLog((data && data.message) ? data.message : ""));

  socket.on("preprocess_progress", (data) => {
    const pct = (data && data.percent != null) ? data.percent : 0;
    const processed = (data && data.processed != null) ? data.processed : 0;
    const total = (data && data.total != null) ? data.total : 0;
    const phase = (data && data.phase) ? data.phase : "";
    setProgress(pct, processed, total, phase);
  });

  socket.on("preprocess_error", (data) => {
    statusText.textContent = "Status: error";
    addLog((data && data.message) ? data.message : "‚ùå error");
    btnStart.disabled = false;
  });

  socket.on("preprocess_done", (data) => {
    statusText.textContent = "Status: done";
    addLog((data && data.message) ? data.message : "‚úÖ done");
    btnStart.disabled = false;
  });

  loadDatasets().catch(err => addLog("‚ùå Failed to load datasets: " + err));
</script>
{% endblock %}