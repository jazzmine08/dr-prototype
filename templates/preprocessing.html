<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DR Ensemble - Preprocessing</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fafafa;
    }

    header {
      background: #111827;
      color: white;
      padding: 14px 20px;
    }

    .brand {
      font-size: 18px;
      font-weight: 700;
      margin-right: 18px;
    }

    nav {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    nav a {
      color: #e5e7eb;
      text-decoration: none;
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
    }

    nav a:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    nav a.active {
      background: rgba(255, 255, 255, 0.16);
      color: #fff;
    }

    main {
      padding: 22px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .muted {
      color: #6b7280;
    }

    .log {
      height: 340px;
      overflow: auto;
      background: #0b0f14;
      color: #d8e1ff;
      padding: 12px;
      border-radius: 12px;
      font-family: Consolas, monospace;
      font-size: 13px;
    }

    button {
      padding: 10px 14px;
      border: 0;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
    }

    button.primary {
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    select,
    input {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: white;
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 22px;
    }

    .status {
      font-weight: 700;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-weight: 700;
      font-size: 12px;
    }

    .progress-wrap {
      background: #e5e7eb;
      border-radius: 999px;
      height: 18px;
      overflow: hidden;
    }

    .progress-bar {
      height: 18px;
      width: 0%;
      background: #22c55e;
      transition: width 150ms linear;
    }

    .samples-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 920px) {
      .samples-grid {
        grid-template-columns: 1fr;
      }
    }

    .sample-box {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }

    .sample-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .sample-img {
      width: 220px;
      height: 220px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }

    .tiny {
      font-size: 12px;
    }
  </style>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body>

  <header>
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <div class="brand">DR Ensemble</div>
        <nav>
          <a href="/">Home</a>
          <a href="/preprocessing" class="active">Preprocessing</a>
          <a href="/eda">EDA</a>
          <a href="/training">Training</a>
          <a href="/ensemble">Ensemble</a>
          <a href="/results">Results</a>
        </nav>
      </div>
      <div class="pill">Dataset Preprocessing</div>
    </div>
  </header>

  <main>
    <h1>Preprocessing</h1>
    <p class="muted" style="margin-top:0;">
      Select dataset (APTOS 2019 or DRTiD) and run preprocessing to generate standardized images for training.
    </p>

    <div class="card">
      <div class="row">
        <label for="datasetSelect"><b>Dataset:</b></label>
        <select id="datasetSelect"></select>

        <label for="limitInput" class="muted">Limit (optional):</label>
        <input id="limitInput" type="number" min="1" placeholder="e.g., 200 (debug)" style="width: 170px;" />

        <button class="primary" id="btnStart">Start Preprocessing</button>
        <button class="secondary" id="btnClear">Clear Log</button>
        <button class="secondary" id="btnShowSamples" title="Load sample (original vs processed)">Show Samples</button>
      </div>

      <p class="muted" style="margin-top: 12px; margin-bottom: 6px;">
        Source: <b id="sourceName">-</b> &nbsp;&nbsp;|&nbsp;&nbsp;
        Output: <b id="outputPath">-</b>
      </p>

      <p class="status" id="statusText">Status: idle</p>
    </div>

    <!-- Progress -->
    <div class="card">
      <h3 style="margin-top:0;">Progress</h3>
      <div class="progress-wrap">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <p class="muted" id="progressText" style="margin:10px 0 0 0;">0% (0 / 0)</p>
    </div>

    <!-- Samples -->
    <div class="card">
      <h3 style="margin-top:0;">Sample Verification (Original vs Processed)</h3>
      <p class="muted" style="margin-top:0;">
        Click <b>Show Samples</b> to load 1 sample per severity level (No DR, Moderate, Proliferative DR).
      </p>

      <div class="samples-grid">
        <div class="sample-box">
          <div class="row" style="justify-content: space-between;">
            <b>No DR</b>
            <span class="muted tiny" id="samples0Meta"></span>
          </div>
          <div id="samples0" class="sample-row"><span class="muted">Click ‚ÄúShow Samples‚Äù.</span></div>
        </div>

        <div class="sample-box">
          <div class="row" style="justify-content: space-between;">
            <b>Moderate</b>
            <span class="muted tiny" id="samples2Meta"></span>
          </div>
          <div id="samples2" class="sample-row"><span class="muted">Click ‚ÄúShow Samples‚Äù.</span></div>
        </div>

        <div class="sample-box">
          <div class="row" style="justify-content: space-between;">
            <b>Proliferative DR</b>
            <span class="muted tiny" id="samples4Meta"></span>
          </div>
          <div id="samples4" class="sample-row"><span class="muted">Click ‚ÄúShow Samples‚Äù.</span></div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="card">
      <h3 style="margin-top:0;">Logs</h3>
      <div id="logBox" class="log"></div>
    </div>
  </main>

  <script>
    const logBox = document.getElementById("logBox");
    const datasetSelect = document.getElementById("datasetSelect");
    const statusText = document.getElementById("statusText");
    const sourceName = document.getElementById("sourceName");
    const outputPath = document.getElementById("outputPath");
    const limitInput = document.getElementById("limitInput");

    const btnStart = document.getElementById("btnStart");
    const btnClear = document.getElementById("btnClear");
    const btnShowSamples = document.getElementById("btnShowSamples");

    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    const socket = io();

    function addLog(msg) {
      const ts = new Date().toLocaleTimeString();
      logBox.innerHTML += `[${ts}] ${msg}<br/>`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function niceDatasetName(ds) {
      if (ds === "aptos2019") return "Google Drive for Desktop (APTOS 2019)";
      if (ds === "drtid") return "Google Drive for Desktop (DRTiD)";
      return ds;
    }

    function updateSourceLine() {
      const ds = datasetSelect.value || "aptos2019";
      sourceName.textContent = niceDatasetName(ds);
      outputPath.textContent = `G:\\My Drive\\dr_prototype\\processed\\${ds}\\processed_final\\`;
    }

    function setProgress(pct, processed, total, phase) {
      const safePct = Math.max(0, Math.min(100, Number(pct) || 0));
      progressBar.style.width = safePct + "%";
      progressText.textContent = `${safePct}% (${processed || 0} / ${total || 0})${phase ? " - " + phase : ""}`;
    }

    function resetProgress() {
      setProgress(0, 0, 0, "");
    }

    function renderSamplePair(containerId, metaId, sample, ds) {
      const el = document.getElementById(containerId);
      const meta = document.getElementById(metaId);

      el.innerHTML = "";
      meta.textContent = "";

      if (!sample || (!sample.original && !sample.processed)) {
        el.innerHTML = `<span class="muted">No images yet.</span>`;
        meta.textContent = `${ds}`;
        return;
      }

      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.gap = "10px";
      wrap.style.flexWrap = "wrap";

      const makeBlock = (title, src) => {
        const block = document.createElement("div");
        block.style.display = "flex";
        block.style.flexDirection = "column";
        block.style.gap = "6px";

        const cap = document.createElement("span");
        cap.className = "muted tiny";
        cap.textContent = title;

        const img = document.createElement("img");
        img.src = src || "";
        img.className = "sample-img";

        block.appendChild(cap);
        block.appendChild(img);
        return block;
      };

      if (sample.original) wrap.appendChild(makeBlock("Original", sample.original));
      if (sample.processed) wrap.appendChild(makeBlock("Processed", sample.processed));

      el.appendChild(wrap);

      meta.textContent = `${ds}${sample.image_id ? " | " + sample.image_id : ""}`;
    }

    async function loadSamples(ds) {
      const url = `/preprocess_samples?dataset=${encodeURIComponent(ds)}`;
      const res = await fetch(url);
      const data = await res.json();

      const samples = (data && data.samples) ? data.samples : [];

      const s0 = samples.find(s => Number(s.class) === 0);
      const s2 = samples.find(s => Number(s.class) === 2);
      const s4 = samples.find(s => Number(s.class) === 4);

      renderSamplePair("samples0", "samples0Meta", s0, ds);
      renderSamplePair("samples2", "samples2Meta", s2, ds);
      renderSamplePair("samples4", "samples4Meta", s4, ds);
    }

    async function loadDatasets() {
      const res = await fetch("/datasets");
      const data = await res.json();
      datasetSelect.innerHTML = "";

      (data.datasets || []).forEach(ds => {
        const opt = document.createElement("option");
        opt.value = ds;
        opt.textContent = (ds === "aptos2019") ? "APTOS 2019" : (ds === "drtid") ? "DRTiD" : ds;
        datasetSelect.appendChild(opt);
      });

      if ([...datasetSelect.options].some(o => o.value === "aptos2019")) {
        datasetSelect.value = "aptos2019";
      }

      updateSourceLine();
    }

    datasetSelect.addEventListener("change", updateSourceLine);

    btnClear.addEventListener("click", () => {
      logBox.innerHTML = "";
      statusText.textContent = "Status: idle";
      resetProgress();
    });

    btnShowSamples.addEventListener("click", async () => {
      const ds = datasetSelect.value || "aptos2019";
      btnShowSamples.disabled = true;
      addLog(`üñºÔ∏è Loading samples for ${ds}...`);
      try {
        await loadSamples(ds);
        addLog(`‚úÖ Samples loaded.`);
      } catch (e) {
        addLog("‚ùå Failed to load samples: " + e);
      } finally {
        btnShowSamples.disabled = false;
      }
    });

    btnStart.addEventListener("click", async () => {
      const ds = datasetSelect.value || "aptos2019";
      const limitVal = limitInput.value && Number(limitInput.value) > 0 ? Number(limitInput.value) : null;

      resetProgress();
      statusText.textContent = `Status: starting preprocessing (${ds})...`;
      addLog(`‚ñ∂Ô∏è Requesting preprocessing for dataset=${ds}${limitVal ? " limit=" + limitVal : ""}`);

      btnStart.disabled = true;

      const payload = { dataset: ds };
      if (limitVal) payload.limit = limitVal;

      try {
        const resp = await fetch("/start_preprocessing", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await resp.json();
        if (out.status === "ok") {
          statusText.textContent = `Status: running (${ds})`;
          addLog(`‚úÖ ${out.message}`);
        } else {
          statusText.textContent = `Status: error`;
          addLog(`‚ùå ${out.message || "Unknown error"}`);
          btnStart.disabled = false;
        }
      } catch (e) {
        statusText.textContent = `Status: error`;
        addLog(`‚ùå Failed to start preprocessing: ${e}`);
        btnStart.disabled = false;
      }
    });

    // Socket events from backend
    socket.on("connect", () => addLog("üîå Socket connected."));
    socket.on("disconnect", () => addLog("‚ö†Ô∏è Socket disconnected."));
    socket.on("preprocess_log", (data) => addLog(data.message || ""));

    socket.on("preprocess_progress", (data) => {
      const pct = (data && data.percent != null) ? data.percent : 0;
      const processed = (data && data.processed != null) ? data.processed : 0;
      const total = (data && data.total != null) ? data.total : 0;
      const phase = (data && data.phase) ? data.phase : "";
      setProgress(pct, processed, total, phase);
    });

    socket.on("preprocess_error", (data) => {
      statusText.textContent = "Status: error";
      addLog(data.message || "‚ùå error");
      btnStart.disabled = false;
    });

    socket.on("preprocess_done", (data) => {
      statusText.textContent = "Status: done";
      addLog(data.message || "‚úÖ done");
      btnStart.disabled = false;
    });

    // init (no auto-sample load)
    loadDatasets().catch(err => {
      addLog("‚ùå Failed to load datasets: " + err);
    });
  </script>

</body>

</html>