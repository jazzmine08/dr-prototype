{% extends "base.html" %}
{% block title %}Ensemble ‚Äî DR Ensemble{% endblock %}

{% block content %}
<h3 class="mb-2">Ensemble</h3>
<p class="text-muted mt-0">
    Pilih dataset + pilih 3 run (DenseNet121, InceptionResNetV2, EfficientNetV2B0).
</p>

<style>
    .rowx {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .gridx {
        display: grid;
        grid-template-columns: 440px 1fr;
        gap: 14px;
    }

    @media (max-width: 1000px) {
        .gridx {
            grid-template-columns: 1fr;
        }
    }

    .log {
        height: 260px;
        overflow: auto;
        background: #0b0f14;
        color: #d8e1ff;
        padding: 12px;
        border-radius: 12px;
        font-family: Consolas, monospace;
        font-size: 13px;
    }

    .small {
        font-size: 12px;
    }

    img.preview {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #fff;
    }

    pre.report {
        white-space: pre-wrap;
        background: #0b0f14;
        color: #d8e1ff;
        padding: 12px;
        border-radius: 12px;
        overflow: auto;
        font-family: Consolas, monospace;
        font-size: 13px;
    }

    .kv {
        display: grid;
        grid-template-columns: 170px 1fr;
        gap: 6px 10px;
        font-size: 13px;
        margin-top: 10px;
    }

    .kv div.k {
        color: #6b7280;
    }

    .kv div.v {
        color: #111827;
        font-weight: 600;
    }
</style>

<div class="gridx">
    <!-- LEFT: controls -->
    <div class="card shadow-sm p-3">
        <label class="fw-bold">Dataset</label>
        <select id="datasetSelect" class="form-select"></select>

        <div class="mt-3">
            <label class="fw-bold">processed_dir</label>
            <input id="processedDir" class="form-control"
                placeholder="X:\dr_prototype\processed\aptos2019\processed_final\train" />
            <div class="text-muted small mt-2">
                Default: <code>X:\dr_prototype\processed\{dataset}\processed_final\train</code>
            </div>
        </div>

        <hr class="my-3" />

        <div class="mt-1">
            <label class="fw-bold">Saved Ensemble Runs</label>
            <select id="savedEnsSelect" class="form-select"></select>
            <div class="rowx mt-2">
                <button class="btn btn-outline-secondary" id="btnRefreshSavedEns">Refresh Saved</button>
                <button class="btn btn-outline-primary" id="btnLoadSavedEns">Load Result</button>
            </div>

        </div>

        <hr class="my-3" />

        <div class="mt-1">
            <label class="fw-bold">Run 1 (DenseNet121)</label>
            <select id="run1" class="form-select"></select>
        </div>

        <div class="mt-3">
            <label class="fw-bold">Run 2 (InceptionResNetV2)</label>
            <select id="run2" class="form-select"></select>
        </div>

        <div class="mt-3">
            <label class="fw-bold">Run 3 (EfficientNetV2B0)</label>
            <select id="run3" class="form-select"></select>
        </div>

        <div class="mt-3">
            <label class="fw-bold">Ensemble Mode</label>
            <select id="modeSelect" class="form-select">
                <option value="softvote_by_qwk" selected>Soft vote ‚Äî weighted by QWK (recommended)</option>
                <option value="softvote_by_valacc">Soft vote ‚Äî weighted by best val acc</option>
                <option value="softvote_equal">Soft vote ‚Äî equal weights (mean)</option>
                <option value="softvote_manual">Soft vote ‚Äî manual weights (w1,w2,w3)</option>
                <option value="hardvote_majority">Hard vote ‚Äî majority</option>
            </select>
        </div>

        <div class="mt-3" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div>
                <label class="fw-bold">w1</label>
                <input id="w1" type="number" step="0.01" placeholder="0.33" class="form-control" disabled />
            </div>
            <div>
                <label class="fw-bold">w2</label>
                <input id="w2" type="number" step="0.01" placeholder="0.33" class="form-control" disabled />
            </div>
            <div>
                <label class="fw-bold">w3</label>
                <input id="w3" type="number" step="0.01" placeholder="0.34" class="form-control" disabled />
            </div>
        </div>

        <div class="mt-3" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label class="fw-bold">Batch Size</label>
                <input id="batchSize" type="number" min="1" value="16" class="form-control" />
            </div>
            <div>
                <label class="fw-bold">Eval Split</label>
                <select id="evalSplit" class="form-select">
                    <option value="val" selected>val (recommended)</option>
                    <option value="test">test</option>
                </select>
            </div>
        </div>

        <div class="rowx mt-3">
            <button class="btn btn-outline-secondary" id="btnRefreshRuns">Refresh Runs</button>
            <button class="btn btn-primary" id="btnStartEnsemble">Run Ensemble</button>
        </div>

        <div class="mt-3 text-muted"><b>Status:</b> <span id="statusText">idle</span></div>

        <div class="mt-3">
            <div class="text-muted fw-bold mb-2">Logs</div>
            <div id="logBox" class="log"></div>
        </div>
    </div>

    <!-- RIGHT: outputs -->
    <div class="card shadow-sm p-3">
        <div class="fw-bold" style="font-size:16px;">Ensemble Result</div>
        <div class="text-muted" id="ensDir" style="margin-top:6px;"></div>

        <div id="ensMetrics" class="kv"></div>

        <div class="mt-3">
            <div class="text-muted fw-bold mb-2">Confusion Matrix</div>
            <img id="imgCM" class="preview" alt="Ensemble confusion matrix" />
        </div>

        <div class="mt-3">
            <div class="text-muted fw-bold mb-2">Classification Report</div>
            <pre id="reportBox" class="report">(no report yet)</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
    const logBox = document.getElementById("logBox");
    const statusText = document.getElementById("statusText");
    const datasetSelect = document.getElementById("datasetSelect");
    const processedDirEl = document.getElementById("processedDir");

    const run1 = document.getElementById("run1");
    const run2 = document.getElementById("run2");
    const run3 = document.getElementById("run3");

    const btnRefreshRuns = document.getElementById("btnRefreshRuns");
    const btnStartEnsemble = document.getElementById("btnStartEnsemble");

    const savedEnsSelect = document.getElementById("savedEnsSelect");
    const btnRefreshSavedEns = document.getElementById("btnRefreshSavedEns");
    const btnLoadSavedEns = document.getElementById("btnLoadSavedEns");

    const ensDir = document.getElementById("ensDir");
    const imgCM = document.getElementById("imgCM");
    const reportBox = document.getElementById("reportBox");
    const ensMetrics = document.getElementById("ensMetrics");

    const batchSizeEl = document.getElementById("batchSize");
    const evalSplitEl = document.getElementById("evalSplit");

    const modeSelect = document.getElementById("modeSelect");
    const w1El = document.getElementById("w1");
    const w2El = document.getElementById("w2");
    const w3El = document.getElementById("w3");

    const socket = (window.io) ? io() : null;

    function addLog(msg) {
        const ts = new Date().toLocaleTimeString();
        logBox.innerHTML += `[${ts}] ${msg}<br/>`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    function setStatus(s) {
        statusText.textContent = s;
    }

    function getDefaultProcessedDir(ds) {
        return `X:\\dr_prototype\\processed\\${ds}\\processed_final\\train`;
    }

    function getProcessedDir(ds) {
        const custom = (processedDirEl.value || "").trim();
        return custom ? custom : getDefaultProcessedDir(ds);
    }

    function setOptions(selectEl, items) {
        selectEl.innerHTML = "";
        items.forEach(it => {
            const opt = document.createElement("option");
            opt.value = it.value;
            opt.textContent = it.label;
            selectEl.appendChild(opt);
        });
    }

    function pickPreferred(selectEl, keyword) {
        const opts = [...selectEl.options];
        const found = opts.find(o => (o.value || "").includes(keyword) || (o.textContent || "").includes(keyword));
        if (found) selectEl.value = found.value;
    }

    async function loadDatasets() {
        try {
            const res = await fetch("/api/datasets");
            const data = await res.json();
            datasetSelect.innerHTML = "";

            (data.datasets || []).forEach(ds => {
                const opt = document.createElement("option");
                opt.value = ds;
                opt.textContent = (ds === "aptos2019") ? "APTOS 2019" : (ds === "drtid") ? "DRTiD" : ds;
                datasetSelect.appendChild(opt);
            });

            if ([...datasetSelect.options].some(o => o.value === "aptos2019")) datasetSelect.value = "aptos2019";
            addLog(`‚úÖ Loaded datasets: ${(data.datasets || []).join(", ") || "(none)"}`);
        } catch (e) {
            addLog("‚ùå Failed to load datasets. Check /api/datasets route.");
        }
    }

    async function refreshRuns() {
        const ds = datasetSelect.value || "aptos2019";
        addLog(`üîÑ Loading base-model runs for ${ds}...`);

        try {
            const res = await fetch(`/api/results/list?dataset=${encodeURIComponent(ds)}`);
            const data = await res.json();

            const items = data.items || [];
            const runs = items.map(r => {
                const model = (r.model || r.backbone || "");
                const acc = (r.best_val_accuracy != null) ? `acc=${Number(r.best_val_accuracy).toFixed(4)}` : "";
                const qwk = (r.kappa_qwk != null) ? `qwk=${Number(r.kappa_qwk).toFixed(4)}` : "";
                const score = [acc, qwk].filter(Boolean).join(" | ");
                return ({
                    value: r.run_id,
                    label: `${r.run_id}  |  ${model}${score ? "  |  " + score : ""}`
                });
            });

            if (runs.length === 0) {
                addLog("‚ö†Ô∏è No base runs found.");
                setOptions(run1, []);
                setOptions(run2, []);
                setOptions(run3, []);
                return;
            }

            setOptions(run1, runs);
            setOptions(run2, runs);
            setOptions(run3, runs);

            pickPreferred(run1, "DenseNet121");
            pickPreferred(run2, "InceptionResNetV2");
            pickPreferred(run3, "EfficientNetV2B0");

            addLog(`‚úÖ Loaded ${runs.length} base run(s).`);
        } catch (e) {
            addLog("‚ùå Failed to load runs. Check /api/results/list route.");
        }
    }

    async function refreshSavedEnsembles(selectLatest = true) {
        const ds = datasetSelect.value || "aptos2019";
        addLog(`üîÑ Loading saved ensemble runs for ${ds}...`);
        try {
            const res = await fetch(`/api/ensemble/list?dataset=${encodeURIComponent(ds)}`);
            const data = await res.json();

            const runs = (data.runs || []).map(rid => ({
                value: rid,
                label: rid
            }));

            if (!runs.length) {
                setOptions(savedEnsSelect, [{ value: "", label: "(no saved ensemble runs)" }]);
                addLog("‚ÑπÔ∏è No saved ensemble runs yet.");
                return;
            }

            setOptions(savedEnsSelect, runs);
            if (selectLatest) savedEnsSelect.value = runs[0].value; // newest first (backend sorts reverse)
            addLog(`‚úÖ Loaded ${runs.length} saved ensemble run(s).`);
        } catch (e) {
            addLog("‚ùå Failed to load saved ensembles. Check /api/ensemble/list route.");
        }
    }

    function renderMetrics(metricsObj) {
        const m = metricsObj || {};
        // try a few common shapes
        const qwk = m.kappa_qwk ?? (m.summary?.kappa_qwk);
        const acc = m.eval_accuracy ?? m.accuracy ?? (m.summary?.accuracy);
        const bva = m.best_val_accuracy ?? (m.summary?.best_val_accuracy);
        const bvl = m.best_val_loss ?? (m.summary?.best_val_loss);

        const rows = [
            ["Eval Accuracy", (acc != null ? Number(acc).toFixed(4) : "-")],
            ["QWK (Kappa)", (qwk != null ? Number(qwk).toFixed(4) : "-")],
            ["Best Val Acc", (bva != null ? Number(bva).toFixed(4) : "-")],
            ["Best Val Loss", (bvl != null ? Number(bvl).toFixed(4) : "-")],
        ];

        ensMetrics.innerHTML = rows.map(([k, v]) => `
            <div class="k">${k}</div><div class="v">${v}</div>
        `).join("");
    }

    async function loadSavedEnsemble(runId) {
        const ds = datasetSelect.value || "aptos2019";
        if (!runId) {
            addLog("‚ö†Ô∏è No saved run selected.");
            return;
        }

        addLog(`üì• Loading saved ensemble: ${runId}`);
        try {
            const res = await fetch(`/api/ensemble/get?dataset=${encodeURIComponent(ds)}&run_id=${encodeURIComponent(runId)}`);
            const data = await res.json();

            if (data.status !== "ok") {
                addLog("‚ùå Failed to load ensemble: " + (data.message || "unknown"));
                return;
            }

            ensDir.textContent = data.run_dir || "";
            reportBox.textContent = data.report || "(no report)";
            imgCM.src = data.images?.["confusion_matrix.png"] || "";
            renderMetrics(data.metrics || {});
            addLog("‚úÖ Loaded saved ensemble result.");
        } catch (e) {
            addLog("‚ùå Error loading saved ensemble: " + (e?.message || e));
        }
    }

    btnRefreshRuns.addEventListener("click", refreshRuns);
    btnRefreshSavedEns.addEventListener("click", () => refreshSavedEnsembles(false));
    btnLoadSavedEns.addEventListener("click", () => loadSavedEnsemble(savedEnsSelect.value));

    datasetSelect.addEventListener("change", async () => {
        processedDirEl.value = "";
        await refreshRuns();
        await refreshSavedEnsembles(true);
    });

    function setManualWeightsEnabled(enabled) {
        w1El.disabled = !enabled;
        w2El.disabled = !enabled;
        w3El.disabled = !enabled;
        if (!enabled) {
            w1El.value = "";
            w2El.value = "";
            w3El.value = "";
        }
    }

    function refreshWeightUI() {
        const mode = modeSelect.value || "softvote_by_qwk";
        setManualWeightsEnabled(mode === "softvote_manual");
    }

    modeSelect.addEventListener("change", refreshWeightUI);
    refreshWeightUI();

    btnStartEnsemble.addEventListener("click", async () => {
        try {
            const ds = datasetSelect.value || "aptos2019";
            if (!run1.value || !run2.value || !run3.value) {
                addLog("‚ùå Please select 3 runs first.");
                return;
            }

            const mode = modeSelect.value || "softvote_by_qwk";

            // Map UI -> backend-friendly payload
            let method = "softvote";
            let weighting = "by_qwk";
            let weights = null;

            if (mode === "softvote_by_qwk") {
                method = "softvote";
                weighting = "by_qwk";
            } else if (mode === "softvote_by_valacc") {
                method = "softvote";
                weighting = "by_valacc";
            } else if (mode === "softvote_equal") {
                method = "softvote";
                weighting = "equal";
            } else if (mode === "softvote_manual") {
                method = "softvote";
                weighting = "manual";
                const w1 = Number(w1El.value || 0);
                const w2 = Number(w2El.value || 0);
                const w3 = Number(w3El.value || 0);
                if (!(w1 > 0 || w2 > 0 || w3 > 0)) {
                    addLog("‚ùå Manual weights selected but w1/w2/w3 are empty.");
                    return;
                }
                weights = [w1, w2, w3];
            } else if (mode === "hardvote_majority") {
                method = "hardvote";
                weighting = "equal";
            }

            const payload = {
                dataset: ds,
                processed_dir: getProcessedDir(ds),
                run_ids: [run1.value, run2.value, run3.value],
                method: method,
                weighting: weighting,
                weights: weights || undefined,
                batch_size: Number(batchSizeEl.value || 16),
                img_size: 224,
                seed: 123,
                cache_dataset: false,
                eval_split: (evalSplitEl.value || "val")
            };

            setStatus("running...");
            btnStartEnsemble.disabled = true;

            addLog(`‚ñ∂Ô∏è Start ensemble for ${ds}`);
            addLog(`‚öôÔ∏è method=${payload.method}, weighting=${payload.weighting}${weights ? ", weights=" + weights.join(",") : ""}, eval_split=${payload.eval_split}`);

            const resp = await fetch("/api/start_ensemble", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const out = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                setStatus("error");
                addLog("‚ùå Start failed: " + (out.message || `HTTP ${resp.status}`));
                return;
            }

            addLog(out.message || "Ensemble started");

        } catch (e) {
            setStatus("error");
            addLog("‚ùå JS error on start: " + (e?.message || e));
        } finally {
            btnStartEnsemble.disabled = false;
        }
    });

    if (socket) {
        socket.on("ensemble_log", (d) => addLog(d.message || JSON.stringify(d)));

        socket.on("ensemble_error", (d) => {
            setStatus("error");
            addLog("‚ùå " + (d.message || JSON.stringify(d)));
        });

        socket.on("ensemble_done", async (d) => {
            setStatus("done");
            addLog("‚úÖ Ensemble done");

            const summary = d.summary || {};
            const runDir = d.run_dir || summary?.run_dir || "";
            ensDir.textContent = runDir;

            // After finish: refresh saved list and auto-load latest
            await refreshSavedEnsembles(true);
            const latest = savedEnsSelect.value;
            if (latest) {
                await loadSavedEnsemble(latest);
            }
        });
    } else {
        addLog("‚ö†Ô∏è Socket.IO not loaded. Realtime logs may not appear.");
    }

    (async function init() {
        await loadDatasets();
        await refreshRuns();
        await refreshSavedEnsembles(true);

        // optional: auto-load latest saved ensemble on first open
        const latest = savedEnsSelect.value;
        if (latest && latest !== "(no saved ensemble runs)") {
            await loadSavedEnsemble(latest);
        }
    })();
</script>
{% endblock %}